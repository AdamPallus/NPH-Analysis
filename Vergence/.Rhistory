zmpp
zmp %>%
select(counter,r.direction,verg.velocity) %>%
group_by(counter,r.direction) %>%
summarize_each(funs(mean))%>%
rename(trans.template=verg.velocity)%>%
mutate(norm.trans.template=trans.template/min(trans.template))->
mean.waveforms
qplot(counter,norm.trans.template,color=r.direction,data=mean.waveforms)
zmp %>%
select(counter,r.direction,verg.velocity) %>%
group_by(counter,r.direction) %>%
summarize_each(funs(mean))%>%
rename(trans.template=verg.velocity)%>%
group_by(direction) %>%
mutate(norm.trans.template=trans.template/min(trans.template))->
mean.waveforms
zmp %>%
select(counter,r.direction,verg.velocity) %>%
group_by(counter,r.direction) %>%
summarize_each(funs(mean))%>%
rename(trans.template=verg.velocity)%>%
group_by(r.direction) %>%
mutate(norm.trans.template=trans.template/min(trans.template))->
mean.waveforms
qplot(counter,norm.trans.template,color=r.direction,data=mean.waveforms)
zmp %>%
select(counter,r.direction,verg.velocity) %>%
group_by(counter,r.direction) %>%
summarize_each(funs(mean))%>%
rename(trans.template=verg.velocity)%>%
group_by(r.direction) %>%
mutate(norm.trans.template=trans.template/min(trans.template)*-1)->
mean.waveforms
qplot(counter,norm.trans.template,color=r.direction,data=mean.waveforms)
group_by(counter) %>%
summarize_each(funs(mean))->
mean.waveforms
mean.waveforms %>%
select(-r.direction) %>%
group_by(counter) %>%
summarize_each(funs(mean))->
mean.waveforms
mean.waveforms %>%
ungroup() %>%
select(-r.direction) %>%
group_by(counter) %>%
summarize_each(funs(mean))->
mean.waveforms
head(mean.waveforms)
qplot(counter,norm.trans.tamplate,data=mean.waveforms)
qplot(counter,norm.trans.template,data=mean.waveforms)
mean.waveforms %>%
ungroup() %>%
select(-r.direction) %>%
group_by(counter) %>%
summarize_each(funs(mean))%>%
filter(counter<150)->
mean.waveforms
mean.waveforms %>%
ungroup() %>%
select(counter,trans.template,norm.trans.template) %>%
group_by(counter) %>%
summarize_each(funs(mean))%>%
filter(counter<150)->
mean.waveforms
qplot(counter,norm.trans.template,data=mean.waveforms)
mean.waveforms %>%
ungroup() %>%
select(counter,trans.template,norm.trans.template) %>%
group_by(counter) %>%
summarize_each(funs(mean))%>%
filter(counter<125)->
mean.waveforms
qplot(counter,norm.trans.template,data=mean.waveforms)
mean.waveforms %>%
ungroup() %>%
select(counter,trans.template,norm.trans.template) %>%
group_by(counter) %>%
summarize_each(funs(mean))%>%
filter(counter<125,counter>20)->
mean.waveforms
qplot(counter,norm.trans.template,data=mean.waveforms)
mean.waveforms %>%
ungroup() %>%
select(counter,trans.template,norm.trans.template) %>%
group_by(counter) %>%
summarize_each(funs(mean))%>%
filter(counter<100,counter>20)->
mean.waveforms
qplot(counter,norm.trans.template,data=mean.waveforms)
summary(trans.mod)
zmpp<- mutate(zmpp,npk=predict(trans.mod,newdata=zmpp))
goodsacs=unique(zmpp$sacnum)
manipulate(ggplot(filter(zmpp,sacnum==goodsacs[sac]))+
geom_line(aes(counter,verg.velocity))+
geom_line(aes(counter,norm.trans.template*npk*-1),color='hotpink'),
sac=slider(1,nsac,step=1)
)
zm %>%
filter(verg.amp>3,
abs(r.amp)>4,
# verg.velocity[30]<0,
# abs(verg.velocity[20])< 20,
# abs(verg.velocity[1])<20,
saccade.dur<100
) %>%
ungroup()->
zmpp
names(zm)
z %>%
group_by(neuron,sacnum) %>%
mutate(saccade.dur=n()-2*bufferlength,
verg.amp=last(verg.angle)-first(verg.angle),
peak.conj.velocity=max(conj.velocity),
R.H.Amp=last(rep)-first(rep),
L.H.Amp=last(lep)-first(lep),
R.V.Amp=last(repV)-first(repV),
L.V.Amp=last(lepV)-first(lepV),
r.angle=atan2(R.V.Amp,R.H.Amp)*180/pi,
r.direction='upward',
r.direction=replace(r.direction,r.angle<0,'downward'),
r.direction=replace(r.direction,abs(r.angle)<45,'rightward'),
r.direction=replace(r.direction,abs(r.angle)>135,'leftward'),
r.amp=sqrt(R.H.Amp^2+R.V.Amp^2),
npk=min(verg.velocity),
ppk=max(verg.velocity))->
zm
t<-NULL
z %>%
group_by(neuron,sacnum) %>%
mutate(saccade.dur=n()-2*bufferlength,
verg.amp=last(verg.angle)-first(verg.angle),
peak.conj.velocity=max(conj.velocity),
R.H.Amp=last(rep)-first(rep),
L.H.Amp=last(lep)-first(lep),
R.V.Amp=last(repV)-first(repV),
L.V.Amp=last(lepV)-first(lepV),
r.angle=atan2(R.V.Amp,R.H.Amp)*180/pi,
r.direction='upward',
r.direction=replace(r.direction,r.angle<0,'downward'),
r.direction=replace(r.direction,abs(r.angle)<45,'rightward'),
r.direction=replace(r.direction,abs(r.angle)>135,'leftward'),
r.amp=sqrt(R.H.Amp^2+R.V.Amp^2),
npk=min(verg.velocity),
ppk=max(verg.velocity))->
zm
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(knitr)
library(tidyr)
library(broom)
# library(grid)
library(relaimpo)
library(leaps)
#library(data.table)
library(stringr)
library(dplyr)
library(cladoRcpp)
select<-dplyr::select
# source('joinsaccadesuniform.R')
source('Adamhelperfunctions.R')
t<- readRDS('SOA-NRTP.RDS')
t<- filter(t,cellnum>100)
unique(t$neuron)
t %>%
group_by(neuron) %>%
mutate(sdf20= lag(sdf,20)) ->
t
t %>% group_by(neuron) %>%
do(joinsaccades(.,buffer=20,threshold=20))->
t
t %>%
group_by(neuron) %>%
# mutate(bin.velocity=cut(verg.velocity,c(seq(-200,200,by=20)))) %>%
# filter(!is.na(sacnum)) %>%
group_by(neuron, sacnum) %>%
mutate(conj.h=(lep+rep)/2,
conj.v=(lepV+repV)/2,
conj.h.amp=last(conj.h)-first(conj.h),
conj.v.amp=last(conj.v)-first(conj.v),
conj.angle=atan2(conj.v,conj.h)*180/pi,
peak.verg.velocity=maxabs(verg.velocity),
r.amp=sqrt(conj.h^2+conj.v^2),
verg.amp=last(verg.angle)-first(verg.angle),
peak.FR=max(sdf20),
saccade.type='conj',
saccade.type=replace(saccade.type,verg.amp< -2 & r.amp>2,'diverging'),
saccade.type=replace(saccade.type,verg.amp> 2& r.amp>2,'converging'),
saccade.type=replace(saccade.type,is.na(sacnum) | r.amp<2,'no.saccade')) ->
t
# t %>%
#   group_by(neuron) %>%
#   rename(verg.velocity.rough=verg.velocity) %>%
#   mutate(verg.velocity=parabolicdiff(lep-rep,20))->
#   t
bufferlength<- 200
saccade.length<- 150
t%>%
filter(neuron=='Bee-101')%>%
# filter(cellnum>100,cellnum<125,monkey=='Bee')%>%
# group_by(neuron) %>%
rename(verg.velocity.rough=verg.velocity) %>%
mutate(sdf20=lag(sdf,20),
lev=parabolicdiff(lep,20),
rev=parabolicdiff(rep,20),
levV=parabolicdiff(lepV,20),
revV=parabolicdiff(repV,20),
verg.velocity=lev-rev,
conj.velocity=sqrt(((rev+lev)/2)^2+((revV+levV)/2)^2)) %>%
# conj.velocity=sqrt((rev^2+lev^2)/2)+sqrt((revV^2+levV^2)/2)) %>%
ungroup() %>%
mutate(time=row_number()) %>%
do(joinsaccadesuniform(.,buffer=bufferlength,threshold=20,saccade.length=saccade.length))->
# do(joinsaccades(.,buffer=bufferlength,threshold=20))->
z
z %>%
# group_by(neuron) %>%
mutate(issaccade=!is.na(sacnum)) %>%
filter(issaccade,saccade.dur>20) %>%
group_by(neuron,sacnum) %>%
mutate(sdf20=lag(sdf,20),
cverg=abs(verg.velocity)>3,
cverg=replace(counter,cverg,NA)) %>%
mutate(saccade.dur=first(saccade.dur), #was originally a summary
saccade.end=saccade.dur+bufferlength,
peak.conj.velocity=maxabs(conj.velocity),
peak.R.H= maxabs(rev),
peak.R.V= maxabs(revV),
peak.L.H= maxabs(lev),
peak.L.V= maxabs(levV),
R.H.Amp=rep[saccade.end]-rep[bufferlength],
L.H.Amp=lep[saccade.end]-lep[bufferlength],
R.V.Amp=repV[saccade.end]-repV[bufferlength],
L.V.Amp=lepV[saccade.end]-lepV[bufferlength],
r.angle=atan2(R.V.Amp,R.H.Amp)*180/pi,
r.amp=sqrt(R.H.Amp^2+R.V.Amp^2),
vect.amp= (sqrt(R.H.Amp^2+R.V.Amp^2)+sqrt(L.H.Amp^2+L.V.Amp^2))/2,
maxamp=max(abs(R.H.Amp),abs(R.V.Amp),abs(L.H.Amp),abs(L.V.Amp)),
verg.amp=verg.angle[saccade.end]-verg.angle[bufferlength],
mean.verg.amp=mean(verg.angle[saccade.end:n()]-mean(verg.angle[1:bufferlength])),
peak.verg.velocity= maxabs(verg.velocity),
min.verg.trans = min(verg.velocity),
max.verg.trans = max(verg.velocity),
off.verg.velocity=min(abs(min.verg.trans),abs(max.verg.trans)),
min.verg.angle=min(verg.angle),
max.verg.angle=max(verg.angle),
max.verg.velocity=max(verg.velocity),
min.verg.velocity=min(verg.velocity),
initial.verg.angle=verg.angle[bufferlength],
verg.lead=bufferlength-max(cverg[100:bufferlength],na.rm=T),
verg.lead=replace(verg.lead,is.na(verg.lead),0))->
z
z%>%
summarize_each(funs(first))->
s
# t %>%
#   group_by(neuron) %>%
#   rename(verg.velocity.rough=verg.velocity) %>%
#   mutate(verg.velocity=parabolicdiff(lep-rep,20))->
#   t
bufferlength<- 200
saccade.length<- 150
t%>%
# filter(neuron=='Bee-101')%>%
# filter(cellnum>100,cellnum<125,monkey=='Bee')%>%
# group_by(neuron) %>%
rename(verg.velocity.rough=verg.velocity) %>%
mutate(sdf20=lag(sdf,20),
lev=parabolicdiff(lep,20),
rev=parabolicdiff(rep,20),
levV=parabolicdiff(lepV,20),
revV=parabolicdiff(repV,20),
verg.velocity=lev-rev,
conj.velocity=sqrt(((rev+lev)/2)^2+((revV+levV)/2)^2)) %>%
# conj.velocity=sqrt((rev^2+lev^2)/2)+sqrt((revV^2+levV^2)/2)) %>%
ungroup() %>%
mutate(time=row_number()) %>%
do(joinsaccadesuniform(.,buffer=bufferlength,threshold=20,saccade.length=saccade.length))->
# do(joinsaccades(.,buffer=bufferlength,threshold=20))->
z
z %>%
# group_by(neuron) %>%
mutate(issaccade=!is.na(sacnum)) %>%
filter(issaccade,saccade.dur>20) %>%
group_by(neuron,sacnum) %>%
mutate(sdf20=lag(sdf,20),
cverg=abs(verg.velocity)>3,
cverg=replace(counter,cverg,NA)) %>%
mutate(saccade.dur=first(saccade.dur), #was originally a summary
saccade.end=saccade.dur+bufferlength,
peak.conj.velocity=maxabs(conj.velocity),
peak.R.H= maxabs(rev),
peak.R.V= maxabs(revV),
peak.L.H= maxabs(lev),
peak.L.V= maxabs(levV),
R.H.Amp=rep[saccade.end]-rep[bufferlength],
L.H.Amp=lep[saccade.end]-lep[bufferlength],
R.V.Amp=repV[saccade.end]-repV[bufferlength],
L.V.Amp=lepV[saccade.end]-lepV[bufferlength],
r.angle=atan2(R.V.Amp,R.H.Amp)*180/pi,
r.amp=sqrt(R.H.Amp^2+R.V.Amp^2),
vect.amp= (sqrt(R.H.Amp^2+R.V.Amp^2)+sqrt(L.H.Amp^2+L.V.Amp^2))/2,
maxamp=max(abs(R.H.Amp),abs(R.V.Amp),abs(L.H.Amp),abs(L.V.Amp)),
verg.amp=verg.angle[saccade.end]-verg.angle[bufferlength],
mean.verg.amp=mean(verg.angle[saccade.end:n()]-mean(verg.angle[1:bufferlength])),
peak.verg.velocity= maxabs(verg.velocity),
min.verg.trans = min(verg.velocity),
max.verg.trans = max(verg.velocity),
off.verg.velocity=min(abs(min.verg.trans),abs(max.verg.trans)),
min.verg.angle=min(verg.angle),
max.verg.angle=max(verg.angle),
max.verg.velocity=max(verg.velocity),
min.verg.velocity=min(verg.velocity),
initial.verg.angle=verg.angle[bufferlength],
verg.lead=bufferlength-max(cverg[100:bufferlength],na.rm=T),
verg.lead=replace(verg.lead,is.na(verg.lead),0))->
z
z%>%
summarize_each(funs(first))->
s
z<-NULL
t %>%
filter(neuron=='Bee-111') %>%
group_by(neuron) %>%
mutate(time=row_number(),
sdf20=lag(sdf,20),
lev=parabolicdiff(lep,10),
rev=parabolicdiff(rep,10),
verg.velocity=lev-rev) %>%
joinsaccadesuniform(buffer=50,threshold=20,saccade.length=150) %>%
group_by(sacnum) %>%
mutate(peakFR=max(sdf20,na.rm=T),
max.verg.velocity=max(verg.velocity),
min.verg.velocity=min(verg.velocity),
peak.verg.velocity=maxabs(verg.velocity))->
z
z %>%
summarize_each(funs(first))->
zp
ggplot(zp)+
geom_point(aes(peak.verg.velocity,peakFR))
names(z)
ggplot(zp)+
geom_point(aes(peak.verg.velocity,peakFR))
cor(sdf20,verg.angle,data=filter(t,neuron=='Bee-111'))
cor(z$sdf20,z$verg.angle)
cor(z$sdf20,z$verg.angle,na.rm=T)
lm(sdf20~verg.angle,data=fitler(t,neuron=='Bee-111'))
lm(sdf20~verg.angle,data=filter(t,neuron=='Bee-111'))
coef(lm(sdf20~verg.angle,data=filter(t,neuron=='Bee-111')))
coef(lm(sdf20~verg.angle,data=filter(t,neuron=='Bee-111')))[2]
sign(coef(lm(sdf20~verg.angle,data=filter(t,neuron=='Bee-111')))[2])
t %>%
# filter(neuron=='Bee-111') %>%
group_by(neuron) %>%
mutate(nearresponse=sign(coef(lm(sdf20~verg.angle,data=.)))>0,
time=row_number(),
sdf20=lag(sdf,20),
lev=parabolicdiff(lep,10),
rev=parabolicdiff(rep,10),
verg.velocity=lev-rev) %>%
joinsaccadesuniform(buffer=50,threshold=20,saccade.length=150) %>%
group_by(sacnum) %>%
mutate(peakFR=max(sdf20,na.rm=T),
max.verg.velocity=max(verg.velocity),
min.verg.velocity=min(verg.velocity),
peak.verg.velocity=maxabs(verg.velocity))->
z
t %>%
# filter(neuron=='Bee-111') %>%
group_by(neuron) %>%
mutate(nearresponse=sign(coef(lm(sdf20~verg.angle,data=.)))>0,
time=row_number(),
sdf20=lag(sdf,20),
lev=parabolicdiff(lep,10),
rev=parabolicdiff(rep,10),
verg.velocity=lev-rev) %>%
joinsaccadesuniform(buffer=50,threshold=20,saccade.length=150) %>%
group_by(neuron,sacnum) %>%
mutate(peakFR=max(sdf20,na.rm=T),
max.verg.velocity=max(verg.velocity),
min.verg.velocity=min(verg.velocity),
peak.verg.velocity=maxabs(verg.velocity))->
z
joinsaccadesuniform
warnings()
warnings()
t<- readRDS('SOA-NRTP.RDS')
t<- readRDS('SOA-NRTP.RDS')
t<- filter(t,cellnum>100)
t %>%
# filter(neuron=='Bee-111') %>%
group_by(neuron) %>%
mutate(nearresponse=sign(coef(lm(sdf20~verg.angle,data=.)))>0,
time=row_number(),
sdf20=lag(sdf,20),
lev=parabolicdiff(lep,10),
rev=parabolicdiff(rep,10),
verg.velocity=lev-rev) %>%
joinsaccadesuniform(buffer=50,threshold=20,saccade.length=150) %>%
group_by(neuron,sacnum) %>%
mutate(peakFR=max(sdf20,na.rm=T),
max.verg.velocity=max(verg.velocity),
min.verg.velocity=min(verg.velocity),
peak.verg.velocity=maxabs(verg.velocity))->
z
t %>%
# filter(neuron=='Bee-111') %>%
group_by(neuron) %>%
mutate(time=row_number(),
sdf20=lag(sdf,20),
nearresponse=sign(coef(lm(sdf20~verg.angle,data=.)))>0,
lev=parabolicdiff(lep,10),
rev=parabolicdiff(rep,10),
verg.velocity=lev-rev) %>%
joinsaccadesuniform(buffer=50,threshold=20,saccade.length=150) %>%
group_by(neuron,sacnum) %>%
mutate(peakFR=max(sdf20,na.rm=T),
max.verg.velocity=max(verg.velocity),
min.verg.velocity=min(verg.velocity),
peak.verg.velocity=maxabs(verg.velocity))->
z
t %>%
# filter(neuron=='Bee-111') %>%
group_by(neuron) %>%
mutate(time=row_number(),
sdf20=lag(sdf,20),
nearresponse=sign(coef(lm(sdf20~verg.angle,data=.)))>0,
lev=parabolicdiff(lep,10),
rev=parabolicdiff(rep,10),
verg.velocity=lev-rev) %>%
joinsaccadesuniform(buffer=50,threshold=20,saccade.length=150) %>%
group_by(neuron,sacnum) %>%
mutate(peakFR=max(sdf20,na.rm=T),
max.verg.velocity=max(verg.velocity),
min.verg.velocity=min(verg.velocity),
peak.verg.velocity=maxabs(verg.velocity))->
z
t %>%
# filter(neuron=='Bee-111') %>%
group_by(neuron) %>%
mutate(time=row_number(),
sdf20=lag(sdf,20),
nearresponse=sign(coef(lm(sdf20~verg.angle,data=.)))>0,
lev=parabolicdiff(lep,10),
rev=parabolicdiff(rep,10),
verg.velocity=lev-rev) %>%
joinsaccadesuniform(buffer=50,threshold=20,saccade.length=150) %>%
group_by(neuron,sacnum) %>%
mutate(peakFR=max(sdf20,na.rm=T),
max.verg.velocity=max(verg.velocity),
min.verg.velocity=min(verg.velocity),
peak.verg.velocity=maxabs(verg.velocity))->
z
t %>%
# filter(neuron=='Bee-111') %>%
group_by(neuron) %>%
mutate(time=row_number(),
sdf20=lag(sdf,20),
nearresponse=sign(coef(lm(sdf20~verg.angle,data=.)))>0,
lev=parabolicdiff(lep,10),
rev=parabolicdiff(rep,10),
verg.velocity=lev-rev) %>%
joinsaccadesuniform(buffer=50,threshold=20,saccade.length=150) %>%
group_by(neuron,sacnum) %>%
mutate(peakFR=max(sdf20,na.rm=T),
max.verg.velocity=max(verg.velocity),
min.verg.velocity=min(verg.velocity),
peak.verg.velocity=maxabs(verg.velocity))->
z
t %>%
# filter(neuron=='Bee-111') %>%
group_by(neuron) %>%
mutate(time=row_number(),
sdf20=lag(sdf,20)) %>%
mutate(nearresponse=sign(coef(lm(sdf20~verg.angle,data=.)))>0,
lev=parabolicdiff(lep,10),
rev=parabolicdiff(rep,10),
verg.velocity=lev-rev) %>%
joinsaccadesuniform(buffer=50,threshold=20,saccade.length=150) %>%
group_by(neuron,sacnum) %>%
mutate(peakFR=max(sdf20,na.rm=T),
max.verg.velocity=max(verg.velocity),
min.verg.velocity=min(verg.velocity),
peak.verg.velocity=maxabs(verg.velocity))->
z
t %>%
# filter(neuron=='Bee-111') %>%
group_by(neuron) %>%
mutate(time=row_number(),
sdf20=lag(sdf,20)) %>%
mutate(#nearresponse=sign(coef(lm(sdf20~verg.angle,data=.)))>0,
lev=parabolicdiff(lep,10),
rev=parabolicdiff(rep,10),
verg.velocity=lev-rev) %>%
joinsaccadesuniform(buffer=50,threshold=20,saccade.length=150) %>%
group_by(neuron,sacnum) %>%
mutate(peakFR=max(sdf20,na.rm=T),
max.verg.velocity=max(verg.velocity),
min.verg.velocity=min(verg.velocity),
peak.verg.velocity=maxabs(verg.velocity))->
z
names(t)
z %>%
summarize(nearresponse=sign(coef(lm(sdf20~verg.angle,data=.)))>0) ->
zn
zn
z %>%
summarize(nearresponse=sign(coef(lm(sdf20~verg.angle,data=.))[2])>0) ->
zn
5
