---
title: "NPHShiny"
author: "Adam"
date: "November 16, 2015"
output: 
  html_document: 
    self_contained: no
runtime: shiny
---

---
title: "BootstrapSaccades"
author: "Adam"
output: html_document
---
#Introduction
This is an analysis of cells believed to be recorded in the NPH of a normal monkey (Bee) and a monkey with exotropia (Patos). The NPH is thought to provide the horizontal integrator for the control of eye movements. Individual neurons in NPH are typically described as either burst-tonic or tonic cells, with activity related to either the position or position and velocity of the eyes. 

#Analysis
* Calclate the lead time for each neuron.
+ shift data from cell and eye coils to align based on lead time
* Identify saccades.
+ for this analysis, we remove periods of fixation
* fit and evaluate a linear model: Firing Rate ~ eye position/velocity, horizontal/vertical, left/right (8 terms)
+ Evaluate using Relative Importance
+ Evaluate using BIC and adjusted R^2, using exhaustive search that finds the best model using 1-8 terms
* Optionally, we can restrict our analysis to just disjunctive saccades. This can help to identify monocular cells, since the parameters during conjugate saccades are typically well correlated.


```{r echo=FALSE} 
library(knitr)
opts_chunk$set(echo=FALSE)
```

```{r,message=FALSE}

library(ggplot2)
library(dplyr)
library(knitr)
library(tidyr)
library(broom)
library(grid)
library(relaimpo)
library(leaps)
library(data.table)

```

```{r loadfiles,cache=TRUE}
#load all the .csv files in the data folder, then add a column naming the neuron, 
#using the file name as the default name, then put them all together in one long data frame

#path<-"~/GitHub/NPH-Analysis/practicedata/"
path<-"~/GitHub/NPH-Analysis/data/"

tt<-read.csv("AllDataShiny.csv")

```


```{r BICcalc, cache=TRUE}
#This function can either just calculate the relative importance or use bootstrapping to find a confidence interval for the relative importance. Bootstrapping obviously takes a long time. Also, it can either fit the model to all of the saccades, or just the disjunctive ones. 

tt %>%
  #filter(maxamp>minAmp & disjEither,sdflag>10) %>%
  group_by(neuron) %>%
#    do(b=boot.relimp(lm("sdflag~rep+rev+repV+revV+lep+lev+lepV+levV",.),b=1999),
    do(b=calc.relimp(lm("sdflag~rep+rev+repV+revV+lep+lev+lepV+levV",.)),
    bic=regsubsets(sdflag~rep+rev+repV+revV+lep+lev+lepV+levV,.)) ->
  bb
```

```{R SHINYTRY}
neurons<-as.character(unique(bb$neuron))

inputPanel(
  selectizeInput("neuronchoice", label = "Select a Neuron:",
              choices = neurons)
)

renderPlot({
  nc<-input$neuronchoice
  x<-filter(bb,neuron==nc)
  plot(x$b[[1]],main=nc)
  #plot(x$bic[[1]],main=nc)
})

renderPlot({
  nc<-input$neuronchoice
  x<-filter(bb,neuron==nc)
  #plot(x$b[[1]],main=nc)
  plot(x$bic[[1]],main=nc)
})

```



