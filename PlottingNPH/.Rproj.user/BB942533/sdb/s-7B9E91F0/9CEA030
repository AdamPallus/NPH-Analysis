{
    "contents" : "---\ntitle: \"NPH rate position analysis\"\nauthor: \"Adam\"\ndate: \"October 5, 2015\"\noutput: \n  html_document: \n    keep_md: yes\n    toc: yes\n---\n\n\n```{r,message=FALSE}\n\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(knitr)\nlibrary(tidyr)\nlibrary(grid)\n\n```\n\n```{r,cache=FALSE}\n#load all the .csv files in the data folder, then add a column naming the neuron, \n#using the file name as the default name, then put them all together in one long data frame\n\n#path<-\"~/GitHub/NPH-Analysis/data/\"\npath<-\"~/GitHub/NPH-Analysis/testdata/\"\nfiles <- list.files(path=path,pattern='*.csv')\nt<-data.frame()\nfor (i in 1:length(files)) {\n  temp <- read.csv(paste(path,files[i],sep=''))\n  temp$neuron<-gsub('.csv','',files[i])\n  t <-rbind(t,temp)\n}\n```\n\nFirst I will plot the average firing rate of the neuron while the eyes are in various positions. I've restricted my analysis to periods when the eyes are not in motion using a simple eye velocity threshold. I require both the vertical and horizontal eye position to be less than one. This allows for pre-movement burst activity to potentially interfere with the static analysis. \n\n```{r}\nthresh=1.5 #points with velocity below threshold are considered fixation\n\n#choose just the points of fixation, then bin the data into 1 degree bins (using round)\n#and calculate the mean firing rate during all the times when the eye is at each position\nt %>%\n  filter(abs(rev)<thresh,abs(revV)<thresh,abs(lev)<thresh,abs(levV)<thresh) %>%\n  mutate(R.Hep=round(rep),R.Vep=round(repV), L.Hep=round(lep),L.Vep=round(lepV)) %>%\n  group_by(R.Hep,R.Vep,L.Hep,L.Vep,neuron) %>%\n  summarize(fr=mean(sdf)) %>%\n  ungroup(.) %>%\n  #use tidyr functions to make columns for eye (left or right), vertrical and horizontal eye position\n  mutate(time=row_number(fr)) %>%\n  gather(temp,P,1:4) %>%\n  separate(temp,c(\"Eye\",\"HV\")) %>%\n  spread(HV,P) ->\n  s\nlevels(s$Eye)<-c(\"Right Eye\",\"Left Eye\") #Change R/L into Right Eye/Left Eye\n```\n\n```{r gridplot, fig.height=22,fig.width=10}\n\n#Just show cells I want\n#s <- filter(s,neuron %in% c(\"Bee6\",\"BeeX1\",\"BeeX2\",\"BeeX3a\",\"BeeX3b\",\"BeeY1\",\"BeeZ1\"))\n#s <- filter(s,neuron %in% c(\"Bee6\",\"BeeZ1\"))\n\n#Create a scaled firing rate by simply dividing by the maximum firing rate in any bin\ns %>%\n  group_by(neuron) %>%\n  mutate(maxFR=max(fr),scaledFR=fr/maxFR) ->\n  ss\n\n#plot\nqplot(Hep,Vep,data=ss,fill=scaledFR)+geom_tile()+facet_grid(neuron~Eye)+\n  scale_fill_gradient(low='black',high='orange')\n```\n\nNext, let's show the rate position curves for horizontal and vertical individually.\n\n```{r}\nt %>%\n  filter(abs(rev)<thresh,abs(revV)<thresh,abs(lev)<thresh,abs(levV)<thresh) %>%\n  select(1,2,4,6,8,10) %>%\n  rename(R.Hep=rep,R.Vep=repV, L.Hep=lep,L.Vep=lepV,fr=sdf) %>%\n  #use tidyr functions to make columns for eye (left or right), vertrical and horizontal eye position\n  mutate(time=row_number(fr))%>%\n  gather(temp,P,2:5) %>%\n  separate(temp,c(\"Eye\",\"HV\")) ->\n  static\n```\n\n```{r RightEye, fig.height=22,fig.width=10}\nstatic$plotHV<-as.factor(static$HV)\nlevels(static$plotHV)<-c(\"Horizontal Eye Position\",\"Vertical Eye Position\")\n\nstatic %>%\n  filter(Eye==\"R\") %>%\n  qplot(P,fr,data=.)+facet_grid(neuron~plotHV)+\n  ggtitle('Right Eye')+\n  stat_smooth(method='lm')\n\n```\n\n```{r LeftEye, fig.height=22,fig.width=10}\nstatic %>%\n  filter(Eye==\"L\") %>%\n  qplot(P,fr,data=.)+facet_grid(neuron~plotHV)+\n  ggtitle('Left Eye')+\n  stat_smooth(method='lm')\n```\n\nNext, I will create a table of the linear regression coefficients for the formula $$F_r=b+k_hE_h + k_hE_v$$, where $E_h$ and $E_v$ are the horizontal and vertical eye positions during periods where the eye velocity is less than `r thresh`. \n\n```{r statTable}\nstatic %>% \n  select(-plotHV) %>%\n  spread(HV,P) %>%\n  filter(Eye ==\"R\") %>%\n  group_by(neuron) %>%\n  do(m=summary(lm(fr~Hep+Vep,data=.))$coefficients) %>%\n  mutate(r.h.slope=m[2],r.v.slope=m[3],r.h.p=m[11],r.v.p=m[12]) %>%\n  select(-m) %>%\n  mutate(r.angle=atan2(r.v.slope,r.h.slope)*180/pi) ->\n  r\n\nstatic %>% \n  select(-plotHV) %>%\n  spread(HV,P) %>%\n  filter(Eye ==\"L\") %>%\n  group_by(neuron) %>%\n  do(m=summary(lm(fr~Hep+Vep,data=.))$coefficients) %>%\n  mutate(l.h.slope=m[2],l.v.slope=m[3],l.h.p=m[11],l.v.p=m[12]) %>%\n  select(-m) %>%\n  mutate(l.angle=atan2(l.v.slope,l.h.slope)*180/pi) ->\n  l\n\nrl<-left_join(r,l,by=\"neuron\")\n\nrl %>% \n  separate(neuron,c(\"animal\",\"cellnum\")) %>%\n  arrange(animal,as.numeric(cellnum)) ->\n  rl\n\nkable(rl)\n```\n\nNow, let's plot the vectors of the preferred position for each cell.\n```{r DirectionPlot,fig.height=10,fig.width=5}\nrl %>%\n  select(c(1,2,3,4,8,9)) %>%\n  gather(\"type\",\"slope\",3:6) %>%\n  separate(type,c(\"eye\",\"HV\",\"x\")) %>%\n  select(-x) %>%\n  spread(HV,slope)%>%\n  ggplot(.) +\n  geom_segment(aes(x=0,xend=h,y=0,yend=v,col=eye),size=1.0,arrow=arrow(20))+\n  facet_grid(animal~.)+\n  xlab(\"Horizontal Slope\")+\n  ylab(\"Vertical Slope\") +\n  scale_color_manual(values=c(\"blue\",\"red\"))+\n  coord_cartesian(xlim=c(-3.5,3.5),ylim=c(-3.5,3.5)) +\n  coord_fixed()\n\n```\n\n```{r DirectionPlotSig,fig.height=10,fig.width=5}\nrl %>%\n  filter(r.h.p<0.001, r.v.p<0.001) %>%\n  select(c(1,2,3,4,8,9)) %>%\n  gather(\"type\",\"slope\",3:6) %>%\n  separate(type,c(\"eye\",\"HV\",\"x\")) %>%\n  select(-x) %>%\n  spread(HV,slope)-> \n  p\nif (nrow(p)> 0) { #make sure at least one cell is significant\n  ggplot(p) +\n  geom_segment(aes(x=0,xend=h,y=0,yend=v,col=eye),size=1.0,arrow=arrow(20))+\n  facet_grid(animal~.)+\n  xlab(\"Horizontal Slope\")+\n  ylab(\"Vertical Slope\") +\n  scale_color_manual(values=c(\"blue\",\"red\"))+\n  coord_cartesian(xlim=c(-3.5,3.5),ylim=c(-3.5,3.5)) +\n  coord_fixed()+\n  ggtitle(\"Only Signficant Slopes\")\n}\n\n```\n",
    "created" : 1443805901493.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "756492531",
    "id" : "9CEA030",
    "lastKnownWriteTime" : 1444419259,
    "path" : "~/GitHub/NPH-Analysis/PlottingNPH/RatePositionAnalysisTest.Rmd",
    "project_path" : "RatePositionAnalysisTest.Rmd",
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "type" : "r_markdown"
}